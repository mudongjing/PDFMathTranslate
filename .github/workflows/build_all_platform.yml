name: All Platform PyInstaller Build (Final No Error)

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release Version (e.g., v1.0.0)'
        required: true
        type: string
        default: v1.0.0

env:
  PYTHON_VERSION: "3.12.9"
  MAIN_ENTRY_FILE: "pdf2zh/pdf2zh.py" # 你的入口文件，按需改即可（比如cli.py）
  APP_NAME: "pdf2zh"
  # ✅ 关键修改1：离线资源目录 移出build，改为根目录的 assets 文件夹，无任何拼接风险
  ASSETS_DIR: "./assets"

jobs:
  build-all-platform:
    name: Build ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            arch: x64
            os_name: windows
            ext: ".exe"
            sep: ";"  # Win的add-data分隔符
          - os: ubuntu-latest
            arch: x64
            os_name: linux
            ext: ""
            sep: ":"  # Linux/macOS的add-data分隔符
          - os: macos-latest
            arch: arm64
            os_name: macos-arm64
            ext: ""
            sep: ":"
          - os: macos-13
            arch: x64
            os_name: macos-x64
            ext: ""
            sep: ":"

    steps:
      - name: Windows PowerShell Policy
        if: matrix.os == 'windows-latest'
        run: Set-ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
        shell: pwsh

      - name: Checkout BabelDOC Metadata
        uses: actions/checkout@v4
        with:
          repository: funstory-ai/BabelDOC
          path: babeldoctemp1234567
          token: ${{ secrets.GITHUB_TOKEN }}
          sparse-checkout: babeldoc/assets/embedding_assets_metadata.py
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - name: Cache BabelDOC Assets
        uses: actions/cache@v4.2.2
        with:
          path: ~/.cache/babeldoc
          key: ${{ matrix.os }}-babel-${{ env.PYTHON_VERSION }}-${{ hashFiles('babeldoctemp1234567/babeldoc/assets/embedding_assets_metadata.py') }}

      - name: Checkout Project Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python & UV
        uses: astral-sh/setup-uv@f94ec6bedd8674c4426838e6b50417d36b6ab231
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Clean Env & Install Dependencies
        shell: bash
        run: |
          rm -rf ./babeldoctemp1234567 ./dist ./build ${{ env.ASSETS_DIR }} || true
          mkdir -p ./dist ./build ${{ env.ASSETS_DIR }}
          uv pip install . --upgrade
          uv pip install pyinstaller pywin32-ctypes
          echo "✅ Env Ready"

      - name: Generate BabelDOC Offline Assets + Force Check
        shell: bash
        run: |
          # 生成离线资源到根目录的assets文件夹
          uv run babeldoc --generate-offline-assets ${{ env.ASSETS_DIR }}
          # ✅ 强制校验：如果资源为空，直接终止并提示
          if [ ! -f "$(find ${{ env.ASSETS_DIR }} -name "*.zip" -type f)" ]; then
            echo "❌ FATAL: No offline assets zip found in ${{ env.ASSETS_DIR }}"
            ls -la ${{ env.ASSETS_DIR }}
            exit 1
          fi
          echo "✅ Assets Generated: $(ls -la ${{ env.ASSETS_DIR }})"

      - name: PyInstaller Build (✅核心修复：绝对路径 + 无通配符 + 最简参数)
        shell: bash
        run: |
          OUTPUT_NAME="${{ env.APP_NAME }}-${{ matrix.os_name }}-${{ github.event.inputs.release_version }}${{ matrix.ext }}"
          # ✅ 关键修复点：
          # 1. 用 ${GITHUB_WORKSPACE} 绝对路径引用资源，彻底杜绝路径拼接错误
          # 2. 直接引用文件夹，删除通配符 * ，100%识别
          # 3. 移除所有可能导致路径混乱的冗余参数
          pyinstaller \
            --onefile \
            --console \
            --name "${OUTPUT_NAME}" \
            --distpath ./dist \
            --clean \
            --optimize=2 \
            --exclude-module=tkinter \
            --exclude-module=matplotlib \
            --exclude-module=unittest \
            --hidden-import=babeldoc \
            --hidden-import=babeldoc.assets \
            --hidden-import=pdfminer \
            --hidden-import=pdfminer.pdfinterp \
            --hidden-import=pdfminer.pdfparser \
            --hidden-import=pdfminer.converter \
            # ✅ 终极修复：绝对路径 + 文件夹引用，无通配符
            --add-data="${{ github.workspace }}/${{ env.ASSETS_DIR }}${{ matrix.sep }}./assets" \
            --add-data="${{ github.workspace }}/script${{ matrix.sep }}./script" \
            ${{ env.MAIN_ENTRY_FILE }}
          echo "✅ Build Success! File: $(ls -la ./dist/)"

      - name: Add Execute Permission (Linux/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: chmod +x ./dist/*

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-${{ matrix.os_name }}-${{ github.event.inputs.release_version }}
          path: ./dist/*
          if-no-files-found: error